{% extends naw|yesno:"naw_navigation.html,navigation.html" %}
{% load staticfiles %}
{% load jsonify %}
{% load i18n %}

{% block extra_head %}


    {#  Remote leaflet  #}
    {#    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css"/>#}
    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>#}

    {#  local leaflet  #}
    <script type="text/javascript" src="{% static 'leafletjs.com/leaflet-0.7.3/leaflet.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'leafletjs.com/leaflet-0.7.3/leaflet.css' %}" />

    {#    <script type="text/javascript" src="https://rawgithub.com/kartena/Proj4Leaflet/master/lib/proj4-compressed.js"></script>#}
    {#    <script type="text/javascript" src="https://rawgit.com/kartena/Proj4Leaflet/master/src/proj4leaflet.js"></script>#}

    {#  remote mapbox - use this is leaflet, probably not both  #}
    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>#}
    {#    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />#}


    {#  remote mapbox draw buttons  #}
    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>#}
    {#    <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' rel='stylesheet' />#}


    {#  local mapbox draw buttons  #}
    {#    <link rel="stylesheet" type="text/css" href="{% static 'mapbox.js/plugins/Leaflet.draw-master/dist/leaflet.draw.css' %}"/>#}
    {#    <script type="text/javascript" src="{% static 'mapbox.js/plugins/Leaflet.draw-master/dist/leaflet.draw.js' %}"></script>#}

    {#  local leaflet draw - with touch!  #}
    <link rel="stylesheet" type="text/css" href="{% static 'Leaflet.draw-master/dist/leaflet.draw.css' %}"/>
    <script type="text/javascript" src="{% static 'Leaflet.draw-master/dist/leaflet.draw.js' %}"></script>

    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>#}
    <script type="text/javascript" src="{% static 'mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js' %}"></script>

    {#    <script src="http://code.jquerygeo.com/jquery.geo-1.0.0-b2.min.js"></script>#}
    <script type="text/javascript" src="{% static 'code.jquerygeo.com/jquery.geo-1.0.0-b2.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'jscoord-1.1.1.js' %}"></script>

    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-image/v0.0.4/leaflet-image.js'></script>#}
    <script type="text/javascript" src="{% static 'mapbox.js/plugins/leaflet-image/v0.0.4/leaflet-image.js' %}"></script>


    <script type="text/javascript" src="{% static 'leaflet-search/leaflet-search.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'leaflet-search/leaflet-search.css' %}"/>

    {#    <script type="text/javascript" src="{% static 'leaflet-polygon-fillPattern-master/leaflet-polygon.fillPattern.js' %}"></script>#}

    {#    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>#}

    {#    <script src="http://d3js.org/topojson.v1.min.js"></script>#}
    <script type="text/javascript" src="{% static 'd3js/topojson.v1.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'chroma.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'html2canvas.js' %}"></script>

    <script type="text/javascript" src="{% static 'dataportal/dataportal.js' %}"></script>
    <script type="text/javascript" src="{% static 'dataportal/local_data_layers.js' %}"></script>

    <script type="text/javascript" src="{% static 'leaflet-pip/leaflet-pip.js' %}"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.core.min.js"></script>
    <script src="{% static 'shim.js' %}"></script>
    <script src="{% static 'xlsx/0.8.0/jszip.js' %}"></script>
    <script src="{% static 'xlsx/0.8.0/xlsx.js' %}"></script>
    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>#}
    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>#}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/ods.js"></script>


    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.5.0/leaflet.markercluster-src.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.5.0/MarkerCluster.Default.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.5.0/MarkerCluster.css"/>

    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>

    <script>
        L.TopoJSON = L.GeoJSON.extend({
            addData: function(jsonData) {
                if (jsonData.type === "Topology") {
                    for (key in jsonData.objects) {
                        geojson = topojson.feature(jsonData, jsonData.objects[key]);
                        L.GeoJSON.prototype.addData.call(this, geojson);
                    }
                }
                else {
                    L.GeoJSON.prototype.addData.call(this, jsonData);
                }
            }
        });
        // Copyright (c) 2013 Ryan Clark
    </script>

{% endblock %}

{% block nav_extras %}
    {% if naw %}
        {#        <li>#}
        {#            <a aria-expanded="false" href="#"><i class="fa fa-sitemap fa-fw"></i> National Assembley for Wales Searches<span class="fa arrow"></span></a>#}
        {#            <ul aria-expanded="false" class="nav nav-second-level scrollable_ul collapse">#}
        {% for naw_key_search in naw_key_searches %}

            {% if naw_key_search.item_list %}
                <li>
                    <a href="#"> {{ naw_key_search.description }}<span class="fa arrow"></span></a>

                    <ul class="nav nav-ul nav-second-level">

                        {% for naw_key_two in naw_key_search.item_list %}

                            {% if naw_key_two.item_list %}
                                <li>
                                    <a href="#"> {{ naw_key_two.description }}<span class="fa arrow"></span></a>

                                    <ul class="nav nav-ul nav-third-level scrollable_ul">

                                        {% for naw_key_three in naw_key_two.item_list %}
                                            <li>
                                                <a href="#" data-naw_key_search_uid="{{ naw_key_three.uid }}" class="remote_data_uid">
                                                    <i class="fa fa-map-marker fa-fw"></i> {{ naw_key_three.description }}</a>
                                            </li>
                                        {% endfor %}

                                    </ul>
                                </li>
                            {% else %}
                                <li>
                                    <a href="#" data-naw_key_search_uid="{{ naw_key_two.uid }}" class="remote_data_uid">
                                        <i class="fa fa-map-marker fa-fw"></i> {{ naw_key_two.description }}</a>
                                </li>
                            {% endif %}


                        {% endfor %}

                    </ul>
                </li>
            {% else %}
                <li>
                    <a href="#" data-naw_key_search_uid="{{ naw_key_search.uid }}" class="remote_data_uid">
                        <i class="fa fa-map-marker fa-fw"></i> {{ naw_key_search.description }}</a>
                </li>
            {% endif %}
        {% endfor %}
        {#            </ul>#}
        {#        </li>#}
    {% endif %}
    {% if not naw %}
        <li>
            <a href="#"><i class="fa fa-sitemap fa-fw"></i> {% trans 'Map layers' %}<span class="fa arrow"></span></a>
            <ul class="nav nav-ul nav-second-level">
                <li>
                    <a id="new_layer_btn" href="#"><i class="fa fa-map-marker fa-fw"></i> {% trans 'NomisAPI Data' %}</a>

                    {#                <a aria-expanded="false" href="#"> Remote Data<span class="fa arrow"></span></a>#}
                    {#                <ul aria-expanded="false" class="nav nav-third-level collapse">#}
                    {#                    <li>#}
                    {#                        <a aria-expanded="false" id="new_layer_btn" href="#"><i class="fa fa-map-marker fa-fw"></i> NomisApi Data</a>#}
                    {#                    </li>#}
                    {#                </ul>#}
                </li>
                <li>
                    <a id="import_local_data_btn" href="#"><i class="fa fa-map-marker fa-fw"></i> {% trans 'Import Local Data' %}</a>
                </li>
                <li>
                    <a href="#"> {% trans 'Welsh Government Mapping Service' %}<span class="fa arrow"></span></a>
                    <ul class="nav nav-ul nav-third-level scrollable_ul">
                        {% for wms_url, wms_layer_set in wms_layers.items %}
                            {% for wms_layer in wms_layer_set %}
                                <li>
                                    <a href="#" data-layer_name="{{ wms_layer.tile_name }}" data-layer_url="{{ wms_url }}" class="wms_toggle">
                                        <i class="fa fa-map-marker fa-fw"></i> {{ wms_layer.name }}</a>
                                </li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </li>

                <li>
                    <a href="#"> {% trans 'WISERD Knowing Localities Research' %}<span class="fa arrow"></span></a>
                    <ul class="nav nav-ul nav-third-level scrollable_ul collapse">
                        {% for upload_layer in upload_layers %}
                            <li>
                                <a href="#" data-layer_name="{{ upload_layer.table_name }}" class="upload_layer_toggle">
                                    <i class="fa fa-map-marker fa-fw"></i> {{ upload_layer.display_name }}</a>
                            </li>
                        {% endfor %}

                        {% for wiserd_layer in wiserd_layers %}
                            <li>
                                <a href="#" data-layer_name="{{ wiserd_layer.table_name }}" class="wiserd_layer_toggle">
                                    <i class="fa fa-map-marker fa-fw"></i> {{ wiserd_layer.display_name }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            </ul>
        </li>
    {% endif %}
{% endblock %}

{% block content %}
    <script>

        var ajax_count = 0;
        var wait_dialog_active = false;
        function add_ajax_waiting(content) {
            ajax_count += 1;
            if (ajax_count == 1 && wait_dialog_active == false) {
                waitingDialog.show(content);
                wait_dialog_active = true;
            }
            console.log('adding ' + ajax_count + wait_dialog_active);

        }
        function ajax_finished() {
            ajax_count -= 1;
            if (ajax_count == 0 && wait_dialog_active == true) {
                wait_dialog_active = false;
                waitingDialog.hide();
            }
            console.log('removing ' + ajax_count + wait_dialog_active);

        }

        var uid = 0;
        function get_next_uid() {
            uid += 1;
            return uid;
        }

        // global namespace
        var DataPortal = DataPortal || {};

        DataPortal.LayerStore = {
            layers: [],

            add_layer: function(layer) {
                console.log('adding layer');
                console.log(layer);

                this.layers.push(layer);
            },

            number_of_layers: function() {
                return this.layers.length;
            },

            get_layer: function(uid) {
                for (var i = 0; i < layer.length; i++) {
                    if (this.layers[i].layer_uid == uid) {
                        return this.layers[i];
                    }
                }
                return null;
            }
        };
        var store = DataPortal.LayerStore;

        function MapLayer() {
            this.layer_uid = '';
            this.geography_id = '';
            this.dataset_id = '';
            this.codelist = {};
            this.topojson_data = null;
            this.topojson_layer = null;
            this.colorpicker = null;
            this.color_scheme = '';
            this.bin_type = '';
            this.num_bins = 0;
            this.name = '';
            this.nomis_variable = '';
            this.is_percentage = false;
            this.suppressed_data = null;
            this.csv_url = '';
            this.feature_data = [];
            this.feature_string_data = [];
            this.legend = null;
        }

        window.ready = function(){
            {#            $('#side-menu').removeData("plugin_metisMenu").metisMenu({toggle: false});#}
            {#            $('#side-menu').metisMenu({toggle: true});#}



        };

        $(document).ready(function () {

            $('.nav-ul').each(function(i, obj) {
                $(this).metisMenu();
            });

            {# FIXME sigh, why are there 4 things here?? #}

            var wms_layers = {};
            var topojson_layers = {};

            var leaflet_layers = [];
            var layer_name_counter = {};


            function toggle_layer(toggle_button) {
                var btn_layer_name = $(toggle_button).data('layer_name');

                {#                Remove the class regardless what's about to happen, can be added back again #}
                $(toggle_button).removeClass('wms_layer_active');
                if (wms_layers.hasOwnProperty(btn_layer_name)) {
                    map.removeLayer(wms_layers[btn_layer_name]);
                    delete wms_layers[btn_layer_name];
                } else {
                    $(toggle_button).addClass('wms_layer_active');
                    var btn_layer_url = $(toggle_button).data('layer_url');

                    {#                    var inspire = L.tileLayer.wms("http://inspire.wales.gov.uk/maps/wms", {#}
                    var inspire = L.tileLayer.wms(btn_layer_url, {
                        layers: btn_layer_name,
                        format: 'image/png',
                        transparent: true,
                        attribution: "wales.gov"
                    });
                    wms_layers[btn_layer_name] = inspire;
                    layerControl.addOverlay(inspire, btn_layer_name);

                    inspire.addTo(map);
                }
            }

            function toggle_wiserd_layer(toggle_button) {
                var btn_layer_name = $(toggle_button).data('layer_name');

                {#                Remove the class regardless what's about to happen, can be added back again #}
                $(toggle_button).removeClass('wms_layer_active');
                if (map_layers.hasOwnProperty(btn_layer_name)) {
                    map.removeLayer(map_layers[btn_layer_name]);
                    delete map_layers[btn_layer_name];
                } else {
                    $(toggle_button).addClass('wms_layer_active');

                    get_geojson_layer('wiserd_layer', [btn_layer_name]);
                }
            }

            $('.wms_toggle').click(function () {
                toggle_layer(this)
            });

            $('.wiserd_layer_toggle').click(function () {
                toggle_wiserd_layer(this)
            });

            $('.upload_layer_toggle').click(function () {
                toggle_upload_layer(this)
            });

            $('.remote_data_uid').click(function () {
                var uid = $(this).data('naw_key_search_uid');

                do_layer_single_uuid(uid, "{% url 'data_api' %}");

            });

            function toggle_upload_layer(toggle_button) {
                var btn_layer_name = $(toggle_button).data('layer_name');

                {#                Remove the class regardless what's about to happen, can be added back again #}
                $(toggle_button).removeClass('wms_layer_active');
                if (map_layers.hasOwnProperty(btn_layer_name)) {
                    map.removeLayer(map_layers[btn_layer_name]);
                    delete map_layers[btn_layer_name];
                } else {
                    $(toggle_button).addClass('wms_layer_active');

                    get_geojson_layer('upload_layer', [btn_layer_name]);
                }
            }

            {#            below is map stuff #}
            var wkt = '';
            var center_lat_lng = '';
            var search_area_geojson = '';
            var geoJson_area_km2 = '';

            var map_height = window.innerHeight;
            var header_height = $('.navbar-header').height();

            {#            console.log(map_height + ' ' + header_height);#}

            var map_div = $('#map_div');
            map_div.css({
                height: map_height - header_height - 5,
                {#                width: $('#page-wrapper').width()#}
            });
            $('#right_sidebar').css({
                height: map_height - header_height - 5
            });

            var map = L.map('map_div').setView([52.4, -3.51], 8);

            var layer_group = new L.LayerGroup();
            {#            var overlays = {#}
            {#                "Empty group": layer_group#}
            {#            };#}
            {#            var layerControl = L.control.layers([], {position: 'bottomleft'}).addTo(map);#}
            var layerControl = L.control.layers([], []).addTo(map);

            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                {#            L.tileLayer('http://i7.cscloud.cf.ac.uk/osmcarto/{z}/{x}/{y}.png?access_token={accessToken}', {#}
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                maxZoom: 15,
                id: 'your.mapbox.project.id',
                accessToken: 'your.mapbox.public.access.token'
            }).addTo(map);


            var info = L.control();
            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };

            L.control.scale().addTo(map);

            var north = L.control({position: "bottomleft"});
            north.onAdd = function(map) {
                var div = L.DomUtil.create("div", "north_arrow");
                div.innerHTML = '{% if use_welsh %}G{% else %}N{% endif %}<br><i class="fa fa-long-arrow-up arrow_center"></i>';
                return div;
            };
            north.addTo(map);

// method that we will use to update the control based on feature properties passed
            info.update = function (props) {
                var value = '';
                if (props) {
                    if (props.hasOwnProperty('response_rate')) {
                        value = props.response_rate;
                    }
                    if (props.hasOwnProperty('REMOTE_VALUE')) {
                        value = props.REMOTE_VALUE;
                    }
                }
                var info_text = '<div style="min-height: 10%">';
                if (props) {
                    if (props.DATA_TITLE) {
                        info_text += '<h3>' + props.DATA_TITLE + '</h3>';
                    } else {
                        info_text += '<h3>{% trans 'Region Data' %}</h3>';
                    }
                    if (props.NAME) {
                        info_text += '<h4>' + props.NAME + '</h4>';
                    }
                    {# Only show alt name it it isn't the same as 'name' #}
                    if (props.ALTNAME) {
                        if (props.NAME) {
                            if (props.NAME != props.ALTNAME) {
                                info_text += '<h4>' + props.ALTNAME + '</h4>';
                            }
                        } else {
                            info_text += '<h4>' + props.ALTNAME + '</h4>';
                        }
                    } else if (props.NameWelsh) {
                        if (props.NAME) {
                            if (props.NAME != props.NameWelsh) {
                                info_text += '<h4>' + props.NameWelsh + '</h4>';
                            }
                        } else {
                            info_text += '<h4>' + props.NameWelsh + '</h4>';
                        }
                    }
                    {#                    info_text += '<h4>' + props.AREA_NAME + '</h4>';#}
                    info_text += '<p><b>VALUE : </b>' + (value + (props.PERCENTAGE == true ? '%': '')) + '</p>';

                    var groups = {};

                    if (props.STRING_DATA) {
                        var strings = '';
                        for (var item in props.STRING_DATA) {
                            if (props.STRING_DATA[item]['grouping']) {
                                if (groups.hasOwnProperty(props.STRING_DATA[item]['grouping'])){
                                    groups[props.STRING_DATA[item]['grouping']]['list'].push(
                                            get_sidebar_text(props, item)
                                    )
                                } else {
                                    groups[props.STRING_DATA[item]['grouping']] = {
                                        'title': props.STRING_DATA[item]['grouping'],
                                        'list': [get_sidebar_text(props, item)]
                                    }
                                }
                            } else {
                                strings += get_sidebar_text(props, item);
                            }

                        }

                        for (var group in groups) {
                            strings += '<div class="sidebar_group">';
                            for (var item_field in groups[group]['list']) {
                                strings += groups[group]['list'][item_field];
                            }
                            strings += '</div>';
                        }

                        info_text += strings;
                    } else {
                        {#                        info_text += '<h4>Hover over a region</h4>';#}
                    }

                    {% if request.user.is_superuser  %}
                        if (props.SEARCH_UUID) {
                            info_text += '<a target="_blank" ' +
                                    'href="{% url 'search_data' 'replace_me'%}">'.replace('replace_me', props.SEARCH_UUID)
                                    + 'Search layer data</a>';
                        }
                    {% endif %}

                    info_text += '</div>';
                    {#                FIXME this is nuts #}
                    {#                this._div.innerHTML = info_text;#}

                    $('#right-component1').html(info_text);
                }
            };
            info.addTo(map);

            function get_sidebar_text(props, item) {
                var strings = '';
                if (props.STRING_DATA[item]['value']) {
                    {#  is it a link? #}
                    if (props.STRING_DATA[item]['value'].toLowerCase().indexOf('http://') == 0) {
                        if (props.STRING_DATA[item]['value'].toLowerCase().indexOf('.jpg') > -1 ||
                                props.STRING_DATA[item]['value'].toLowerCase().indexOf('.png') > -1) {
                            {#  it's an image? #}
                            strings += ''
                                    {#                                    + '<p><b>' + props.STRING_DATA[item]['title'] + '</b></p>'#}
                                    + '<p><img src="' + props.STRING_DATA[item]['value'] + '"></p>';
                        } else {
                            {#                                        It's a hyperlink #}
                            strings += ''
                                    {#                                    + '<p><b>' + props.STRING_DATA[item]['title']#}
                                    {#                                    + '</b></p>'#}
                                    + '<p><a target="_blank" href="'
                                    + props.STRING_DATA[item]['value']
                                    + '">' + props.STRING_DATA[item]['title'] + '</a></p>';
                        }
                    }
                    else {
                        strings += '<p><b>' + props.STRING_DATA[item]['title']
                                + '</b>:' + props.STRING_DATA[item]['value'] + '</p>';
                        {#                        console.log(props.STRING_DATA[item]['value']);#}
                    }
                }
                return strings;
            }

            var geojson;
            function resetHighlight(e) {
                e.target.resetStyle(e.target);
                info.update();
            }

            function highlightFeature(e) {
                var layer = e.target;
                layer.setStyle({
                    weight: 5,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                });
                {#                if (!L.Browser.ie && !L.Browser.opera) {#}
{#                layer.bringToFront();#}
                {#                }#}
                info.update(layer.feature.properties);
            }

            function djb2(str){
                var hash = 5381;
                for (var i = 0; i < str.length; i++) {
                    hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
                }
                return hash;
            }

            function hashStringToColor(str) {
                var hash = djb2(str);
                var r = (hash & 0xFF0000) >> 16;
                var g = (hash & 0x00FF00) >> 8;
                var b = hash & 0x0000FF;
                return "#" + ("0" + r.toString(16)).substr(-2) + ("0" + g.toString(16)).substr(-2) + ("0" + b.toString(16)).substr(-2);
            }

            function getColorFromString(string_value) {
                {#                alert(string_value);#}
                {#                alert(string_value.length);#}
                if (string_value == 'LAB') {
                    return '#d50000'
                }
                if (string_value == 'CON') {
                    return '#0087dc'
                }
                if (string_value == 'LIB') {
                    return '#FDBB30'
                }
                if (string_value == 'NAT') {
                    return '#3F8428'
                }
                if (string_value == 'PLC') {
                    return '#3F8428'
                }
                if (string_value == 'UKIP') {
                    return '#70147A'
                }
                if (string_value == 'OTH') {
                    return '#343434'
                }
                return hashStringToColor(string_value)
            }

            {#        TODO check what this is returning #}
            function getColor(d, feature_data, chroma_scale) {

                if (chroma_scale) {
                    return chroma_scale(parseFloat(d));
                }

                if (feature_data) {
                    var scale = chroma.scale('OrRd').classes(feature_data);
                    return scale(parseFloat(d));
                }

                d = parseFloat(d);
                return chroma.random();

                return d > 80 ? '#800026' :
                        d > 75  ? '#BD0026' :
                                d > 70  ? '#E31A1C' :
                                        d > 60  ? '#FC4E2A' :
                                                d > 50   ? '#FD8D3C' :
                                                        d > 40   ? '#FEB24C' :
                                                                d > 30   ? '#FED976' :
                                                                        '#FFEDA0';
            }

            function remove_layer(remove_button){
                map.removeLayer(map_layers[$(remove_button).data('layername')]);
            }

            function replace_layer(replace_button){
                map_layers[$(replace_button).data('layername')].addTo(map);
            }

            {#            get_geojson_layer('survey', JSON.parse('{{ surveys|safe }}'));#}

            function get_geojson_layer(layer_type, layer_names){
                add_ajax_waiting('{% trans 'Fetching map layer...' %}');

                var ajax_url = "{% url 'get_geojson' %}";

                if( layer_type == 'upload_layer'){
                    ajax_url = "{% url 'get_imported_feature' %}";
                } else {
                    ajax_url = "{% url 'get_geojson' %}";
                }

                $.ajax({
                    {#                    url: "{% url 'get_geojson' %}",#}
                    url: ajax_url,
                    type: 'POST',
                    data: {
                        'layer_type': layer_type,
                        'layer_names': layer_names
                        {#                        'area_names': {{ area_names|safe }}#}
                    },
                    success: function(data) {

                        var name = layer_names;

                        {#                        $('#side-menu').removeData("plugin_metisMenu").metisMenu({toggle: false});#}

                        $('.replace_layer').click(function () {
                            replace_layer(this)
                        });
                        $('.remove_layer').click(function () {
                            remove_layer(this)
                        });

                        $('.show_layer').click(function () {
                            var btn_span = $(this);
                            if(btn_span.data('visible')) {
                                btn_span.data('visible', false);
                                btn_span.removeClass('fa-eye').addClass('fa-eye-slash');
                            } else {
                                btn_span.data('visible', true);
                                btn_span.removeClass('fa-eye-slash').addClass('fa-eye');
                            }
                        });

                        if (layer_type == 'survey') {
                            geojson = L.geoJson(data, {
                                onEachFeature: function (feature, layer) {
                                    {#                                    layer.bindPopup(feature.properties.area_name + '<br>' + feature.properties.response_rate + '%');#}
                                    layer.on({
                                        mouseover: highlightFeature,
                                        mouseout: resetHighlight
                                    });
                                },
                                style: function (feature) {
                                    return {
                                        fillColor: getColor(feature.properties.response_rate),
                                        weight: 2,
                                        opacity: 1,
                                        color: 'white',
                                        dashArray: '3',
                                        fillOpacity: 0.7
                                    };
                                }

                            });
                            geojson.addTo(map);
                            geojson.bringToFront();
                            map_layers[data['properties']['name']] = geojson;
                        }

                        if (layer_type == 'wiserd_layer') {
                            {#                            wiserd_layer.addData(data);#}

                            var myLayer = L.geoJson(data, {
                                onEachFeature: function (feature, layer) {
                                    {#                                    console.log(feature);#}
                                    {#                                    console.log(layer);#}
                                    {#                                    layer.bindPopup(layer.feature.properties.AREA_NAME);#}
                                    layer.on({
                                        mouseover: function(e){
                                            var layer = e.target;
                                            layer.setStyle({
                                                weight: 5,
                                                color: '#666',
                                                dashArray: '',
                                                fillOpacity: 0.7
                                            });
                                            {#                if (!L.Browser.ie && !L.Browser.opera) {#}
{#                                            layer.bringToFront();#}
                                            {#                }#}
                                            info.update(layer.feature.properties);
                                        },
                                        mouseout: function(e){
                                            {#                                            console.log(e.target);#}
                                            myLayer.resetStyle(e.target);
                                            {#                                            info.update();#}
                                        }
                                    });
                                },
                                style: function (feature) {
                                    return {
                                        fillColor: '#0044AA',
                                        fillOpacity: 0.7,
                                        weight: 2,
                                        opacity: 1,
                                        color: 'orangered',
                                        dashArray: '3'
                                    };
                                }
                            });
                            layerControl.addOverlay(myLayer, name);
                            myLayer.addTo(map);
                            map_layers[data['properties']['name']] = myLayer;
                        }

                        if (layer_type == 'upload_layer') {

                            topojson_layers[layer_names] = data;
                            $( "#chloropleth_option_form").data(
                                    {layer_names: layer_names}
                            ).dialog( "open" );

                        }
                    },
                    error: function() {
                        alert('{% trans 'Sorry, an error occurred. Please try again, or report it.' %}')
                    },
                    complete: function() {
                        {#                        waitingDialog.hide();#}
                                            ajax_finished();

                    }
                });
            }


            function handleUploadedLayer(data, color_scheme, bin_breakdown, num_bins, nomis_variable, layer_name_text, csv_url){

                if (layer_name_counter.hasOwnProperty(layer_name_text)) {
                    var counter = layer_name_counter[layer_name_text];
                    var tmp_layer_name_text = layer_name_text + '_' + counter;
                    layer_name_counter[layer_name_text] = (counter += 1);
                    layer_name_text = tmp_layer_name_text;
                } else {
                    layer_name_counter[layer_name_text] = 1
                }
                var a_uid = get_next_uid();
                var unique_layer_name_text = layer_name_text + '_' + a_uid;


                {#                console.log(color_scheme, bin_breakdown, num_bins, nomis_variable, layer_name_text, csv_url);#}
                var is_percentage = false;
                var suppressed_data = false;
                var fake_data = false;
                var opacity = {% if naw %}1{% else %}0.7{% endif %};
                if (nomis_variable) {
                    if (nomis_variable == 20301) {
                        is_percentage = true;
                    }
                }

                if (color_scheme == 'naw') {
                    {#                    color_scheme = ['001E62', '4f2c1d', '651D32', '004E42', '131E29'];#}
                    {#                    color_scheme = ['009ca6', 'fe5000', 'cc007b', '3fa628', 'cb102e'];#}
                    color_scheme = ['white', 'FE5000', 'C8102E', '651D32', '131E29'];
                    color_scheme = ['lightpink', 'pink', 'hotpink', 'deeppink', 'd95dd1'];

                }
                if (color_scheme == 'b_w') {
                    color_scheme = ['white', 'black'];
                }
                if (color_scheme == 'w') {
                    color_scheme = ['white', 'white'];
                    opacity = 0;
                }

                {#                if (!data.hasOwnProperty('objects')) {#}
                {#                    var untouched = jQuery.extend(true, {}, data);#}
                {#                    console.log(untouched);#}
                {#                    var features = data['features'];#}
                {#                    delete data['features'];#}
                {#                    data['objects'] = {#}
                {#                        'name': features#}
                {#                    };#}

                {#                console.log(data);#}

                var data_objects = data['objects'];
                var feature_data = [];
                var feature_string_data = [];

                {#  This is listing all the response rate variables we know can find in the topojson #}
                for (var b in data_objects) {
                    var geometries_properties = data_objects[b]['geometries'];
                    for (var a in geometries_properties) {
                        if (geometries_properties[a]['properties']['DATA_STATUS'] == 'Q') {
                            suppressed_data = true;
                        }

                        if (geometries_properties[a]['properties']['REMOTE_VALUE']) {
                            var remote_value = geometries_properties[a]['properties']['REMOTE_VALUE'];
                            if (isNaN(remote_value)) {
                                feature_string_data.push(remote_value);
                            } else {
                                feature_data.push(parseFloat(remote_value));
                            }
                        } else {
                            var fake_value = Math.floor((Math.random() * 100) + 1);
                            geometries_properties[a]['properties']['REMOTE_VALUE'] = fake_value;
                            geometries_properties[a]['properties']['RENDER'] = false;
                            feature_data.push(parseFloat(fake_value));
                            fake_data = true;
                        }
                    }
                }

                if (fake_data) {
                    alert('WARNING: some required data not found, so has been spoofed with random data.');
                    console.log('SPOOFED remove me')
                }

                var unique_feature_string_data = [];
                for (var string_idx in feature_string_data) {
                    if (unique_feature_string_data.indexOf(feature_string_data[string_idx]) == -1) {
                        unique_feature_string_data.push(feature_string_data[string_idx]);
                        {#                        alert(feature_string_data[string_idx]);#}
                    }
                }

                if (feature_string_data.length > 0) {
                } else {
                    if (suppressed_data) {
                        throw "suppressed_data";
                    }
                    if (feature_data.length == 0) {
                        throw "feature_data_0";
                    }
                }

                var chroma_scale = null;
                var grades = null;

                if (feature_data.length > 1) {

                    {#                    console.log(feature_data);#}
                    var data_len = feature_data.length;
                    if (num_bins > data_len) {
                        num_bins = data_len;
                    }

                    {#  Calculating the bins for quantiles with 'q' option, 'e'  and 'k' available #}
                    grades = chroma.limits(feature_data, bin_breakdown, parseInt(num_bins));
                    {#                    console.log(grades);#}

                    {#  Calculating the function we can pass values to, in order to get nice rgb color codes #}
                    chroma_scale = chroma.scale(color_scheme).classes(grades);
                    {#                    console.log(chroma_scale);#}
                }

                var geojsonMarkerOptions = {
                    radius: 8,
                    fillColor: "#ff7800",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };

                var myLayer = new L.TopoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        {#                        if (feature.properties.RENDER == true) {#}
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                        {#                        }#}
                    }
                });

                leaflet_layers.push({
                    name: layer_name_text,
                    layer: myLayer,
                    attribution: 'hello world'
                });

                myLayer.eachLayer(function (layer) {
                    if (typeof layer.setStyle === 'function') {
                        layer.setStyle(styleFeature(layer.feature, grades, chroma_scale, opacity));
                    }
                });
                myLayer.eachLayer(handleLayer);

                layerControl.addOverlay(myLayer, layer_name_text);

                map.on('overlayremove', function (eventLayer) {
                    if (eventLayer.name == layer_name_text) {
                        {#                        console.log('trying to remove : ' + '#accordion_inner_collapse_' + unique_layer_name_text);#}
                        $('#accordion_inner_collapse_' + unique_layer_name_text.replace(/\W/g, '')).remove();
                    }
                });
                map.on('overlayadd', function (eventLayer) {
                    if (eventLayer.name == layer_name_text) {
                        var div_inner = build_legend(feature_data,
                                unique_feature_string_data,
                                chroma_scale,
                                grades, is_percentage);
                        addLegend(unique_layer_name_text, layer_name_text, div_inner);
                    }
                });


                var is_clustermarkers = false;
                var is_heatmap = false;

                myLayer.eachLayer(function (layer) {
                    if (layer.feature.type === 'Feature') {
                        {# enable this line if we want clustered markers #}
                        {#                                                is_clustermarkers = true;#}
{#                                                is_heatmap = true;#}

                    }
                });

                if (is_clustermarkers) {
                    var markers = L.markerClusterGroup();
                    myLayer.eachLayer(function (layer) {
                        if (layer.feature.type === 'Feature') {
                            markers.addLayer(layer);
                        }
                    });
                    map.addLayer(markers);
                    map.fitBounds(markers.getBounds(), { paddingBottomRight: [200, 0] });
                    markers.bringToFront();
                }
                else if (is_heatmap){
                    var heat_data = [];
                    myLayer.eachLayer(function (layer) {
                        if (layer.feature.type === 'Feature') {
                            {#                            console.log(layer);#}
                            heat_data.push([layer.feature.geometry.coordinates[1],
                                layer.feature.geometry.coordinates[0],
                                layer.feature.REMOTE_VALUE * layer.feature.REMOTE_VALUE])
                        }
                    });

                    var heat = L.heatLayer(heat_data, {radius: 25});
                    heat.addTo(map);
                }
                else{
                    myLayer.addTo(map);
                    map.fitBounds(myLayer.getBounds(), { paddingBottomRight: [200, 0] });
                    myLayer.bringToFront();
                }

            }

            function handleLayer(layer) {

                {#                layer.bindPopup(layer.feature.properties.AREA_NAME + '<br>'#}
                {#                        + layer.feature.properties.REMOTE_VALUE +#}
                {#                        (layer.feature.properties.PERCENTAGE == true ? '%': ''));#}

                layer.on({
                    mouseover: function (e) {
                        {#                        console.log(e.target.feature.properties.RESPONSE_R);#}
                        var layer = e.target;
                        layer.setStyle({
                            weight: 5,
                            color: '#666',
                            dashArray: '',
                            fillOpacity: {% if naw %}1{% else %}0.7{% endif %}
                        });

{#                        layer.bringToFront();#}

                        {#                        info.update(layer.feature.properties);#}

                        {#                        var html = '';#}
                        {#                        // look through each layer in order and see if the clicked point,#}
                        {#                        // e.latlng, overlaps with one of the shapes in it.#}
                        {##}
                        {#                        for (var i = 0; i < leaflet_layers.length; i++) {#}
                        {##}
                        {#                            var match = leafletPip.pointInLayer(#}
                        {#                                    // the clicked point#}
                        {#                                    e.latlng,#}
                        {#                                    // this layer#}
                        {#                                    leaflet_layers[i].layer,#}
                        {#                                    // whether to stop at first match#}
                        {#                                    true);#}
                        {##}
                        {#                            // if there's overlap, add some content to the popup: the layer name#}
                        {#                            // and a table of attributes#}
                        {#                            if (match.length) {#}
                        {#                                .log(match[0].feature.properties);#}
                        {#                                html += '<strong>' + leaflet_layers[i].name + '</strong>';#}
                        {#                                html += propertyTable(match[0].feature.properties) + '<br><br>';#}
                        {#                            }#}
                        {#                        }#}
                        {#                        if (html) {#}
                        {#                            $('#right-component1').append(html);#}
                        {#                        }#}

                    },
                    mouseout: function (e) {
                        {#                        e.target.resetStyle(e.target);#}
                        e.target.setStyle({
                            {#                            fillColor: '#0044AA',#}
                            fillOpacity: {% if naw %}1{% else %}0.7{% endif %},
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3'
                        });
                        {#                        info.update();#}
                    },
                    click: function(e) {
                        layer.bringToFront();

                        info.update(layer.feature.properties);

                        var html = '';
                        // look through each layer in order and see if the clicked point,
                        // e.latlng, overlaps with one of the shapes in it.

                        for (var i = 0; i < leaflet_layers.length; i++) {

                            var match = leafletPip.pointInLayer(
                                    // the clicked point
                                    e.latlng,
                                    // this layer
                                    leaflet_layers[i].layer,
                                    // whether to stop at first match
                                    true);

                            // if there's overlap, add some content to the popup: the layer name
                            // and a table of attributes

                            {#                            TODO - we've just checked all layers for a click, #}
                            {#                            TODO and totally ignored them #}
                            {#                            if (match.length) {#}
                            {#                                console.log(match[0].feature.properties);#}
                            {#                                html += '<strong>' + leaflet_layers[i].name + '</strong>';#}
                            {#                                html += propertyTable(match[0].feature.properties) + '<br><br>';#}
                            {#                            }#}
                        }
                        if (html) {
                            {#                            map.openPopup(html, e.latlng);#}
                            $('#right-component1').append(html);
                        }
                    }
                });
            }

            function build_legend(feature_data, unique_feature_string_data, chroma_scale, grades, is_percentage) {
                var labels = [], from, to;
                if (feature_data.length > 1) {
                    {#  For each bin in the quantiles, we need a representative color for the Legend #}
                    for (var i = 0; i < grades.length -1; i++) {
                        from = grades[i];
                        to = grades[i + 1];

                        var legend_row = '<p style="text-align:center;"><i style="background:' + getColor(from, grades, chroma_scale) + '"></i> ';
                        legend_row += from.toFixed(2);
                        if (to) {
                            legend_row += (to).toFixed(2) ? (i == 0 ? ' &ndash; ': ' &le; ') + (to).toFixed(2) + (is_percentage ? '%' : '') : (is_percentage ? '%+' : '+');
                        } else {
                            legend_row += (is_percentage ? '%' : '');
                        }
                        legend_row += '</p>';
                        labels.push(legend_row);
                    }
                }
                if (unique_feature_string_data.length > 0) {
                    for (var string_idx in unique_feature_string_data) {
                        var legend_string_row = '<p><i style="background:' + getColorFromString(unique_feature_string_data[string_idx]) + '"></i> ' + unique_feature_string_data[string_idx] + '</p>';
                        labels.push(legend_string_row);
                    }
                }
                var div_inner = labels.join('');
                div_inner += '</div>';
                return div_inner;
            }

            function addLegend(unique_layer_name_text, layer_name_text, contentHTML){

                {#                var a_uid = get_next_uid();#}
                {#                var tab_id = ("collapse_" + a_uid + '_' + div_id).replace(/\W/g, '');#}
                var tab_id = ("collapse_" + unique_layer_name_text).replace(/\W/g, '');
                var accordionInner = $('<div/>')
                        .attr('id', 'accordion_inner_' + tab_id)
                        .addClass("panel panel-default")
                        .append(
                                $('<div/>')
                                        .addClass("panel-heading")
                                        .append(
                                                $('<h4/>')
                                                        .addClass("panel-title")
                                                        .append(
                                                                $('<a/>')
                                                                        .attr('data-toggle', "collapse")
                                                                        .attr('data-parent', "#legend_accordion")
                                                                        .attr('href', "#" + tab_id)
                                                                        .text(layer_name_text)
                                                        )
                                        )
                        )
                        .append(
                                $('<div/>')
                                        .attr('id', tab_id)
                                        .addClass("panel-collapse collapse in")
                                        .append(
                                                $('<div/>')
                                                        .addClass("panel-body")
                                                        .wrapInner(contentHTML)
                                                {#                                        .text('Lorem ipsum dolor sit amet, consectetur adipisicing elit, minim veniam, quis nostrud')#}
                                        )
                        );
                var accordionDiv = $('#legend_accordion');
                $(accordionDiv).append(accordionInner);
            }

            var legend_two = L.control({id: 'legend_control', position: 'bottomright'});
            legend_two.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'legend info');

                {#                    var legendHeaderDiv = $('<div/>')#}
                {#                            .addClass("panel-heading")#}
                {#                            .text('Legend');#}

                var accordionDiv = $('<div/>')
                        .attr("id", "legend_accordion")
                        .addClass("panel-group");

                $(div).append(accordionDiv)
                        .css({'max-height': map_div.height() * 0.8, 'overflow-y': 'auto'});
                {#                        .draggable().resizable();#}

                return div;
            };
            legend_two.addTo(map);

            {#            FIXME re add and move me#}
            {#            var div = L.DomUtil.create('div', 'info legend');#}
            {#            var legendHeaderDiv = $('<div/>')#}
            {#                    .addClass("panel-heading")#}
            {#                    .text('Legend');#}
            {#            var accordionDiv = $('<div/>')#}
            {#                    .attr("id", "legend_accordion")#}
            {#                    .addClass("panel-group");#}
            {#            $(div).append(legendHeaderDiv).append(accordionDiv);#}
            {#            $('#right-component2').append(div);#}

            {#            $('.legend').resizable({handles: 'n, e, s, w'});#}

            function propertyTable(o) {
                {#                var t = '<table>';#}
                {#                for (var k in o) {#}
                {#                    if (typeof(o[k]) != 'object') {#}
                {#                        t += '<tr><th>' + k + '</th><td>' + o[k] + '</td></tr>';#}
                {#                    }#}
                {#                }#}
                {#                t += '</table>';#}

                var propertyList = '';
                for (var k in o) {
                    if (typeof(o[k]) != 'object') {
                        propertyList += '<p><b>' + k + '</b></p><p>' + o[k] + '</p>';
                        {#                        .replace('""', '"')#}
                    }
                }
                return propertyList;
            }

            function styleFeature(feature, feature_data, chroma_scale, opacity) {
                {#            console.log(feature, feature_data, chroma_scale, opacity);#}

                var colour = '';
                var remote_value = feature.properties.REMOTE_VALUE;

                if (remote_value === undefined){
                    return {
                        {#                        fillColor: '#333333',#}
                        fill: 'url({% static 'leaflet-polygon-fillPattern-master/example/image.gif' %})',
                        stroke: '#fff',
                        'stroke-width': 2,
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: opacity
                    }
                } else {

                    if (isNaN(remote_value)) {
                        {#                        alert(feature.properties);#}
                        {#                        console.log(feature);#}
                        colour = getColorFromString(remote_value);
                    } else {
                        colour = getColor(remote_value, feature_data, chroma_scale);
                    }

                    return {
                        fillColor: colour,
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: opacity
                    };
                }
            }

            var map_layers = {};
            var featureGroup = L.featureGroup().addTo(map);

            map.addControl( new L.Control.Search({
                url: 'http://nominatim.openstreetmap.org/search?format=json&q={s}',
                jsonpParam: 'json_callback',
                propertyName: 'display_name',
                propertyLoc: ['lat','lon'],
                circleLocation: false,
                markerLocation: true,
                autoType: false,
                autoCollapse: true,
                minLength: 2,
                zoom:10
            }) );

            var drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: featureGroup
                },
                draw: {
                    polygon: true,
                    polyline: false,
                    rectangle: {
                        shapeOptions : {
                            color : '#888888'
                        }
                    },
                    circle: true,
                    marker: false
                }
            }).addTo(map);

            map.on('draw:created', showPolygonArea);
            map.on('draw:edited', showPolygonAreaEdited);

            function convertPolygonToOS(shape_geojson){

                var new_coordinates = [];
                var new_geometry = {
                    "type": "Polygon",
                    "coordinates": [[]]
                };

                for (var a = 0; a < shape_geojson['geometry']['coordinates'][0].length; a++) {
                    var ll2 = new LatLng(shape_geojson['geometry']['coordinates'][0][a][1],
                            shape_geojson['geometry']['coordinates'][0][a][0]);
                    var os2 = ll2.toOSRef();
                    new_coordinates.push([os2.easting, os2.northing]);
                }

                new_geometry['coordinates'] = [new_coordinates];

                return new_geometry

            }
            function showPolygonAreaEdited(e) {
                e.layers.eachLayer(function(layer) {
                    showPolygonArea({ layer: layer });
                });
            }

            function showPolygonArea(e) {

                featureGroup.clearLayers();
                featureGroup.addLayer(e.layer);

                geoJson_area_km2 = (LGeo.area(e.layer) / 1000000).toFixed(2);
                e.layer.bindPopup(geoJson_area_km2 + ' km<sup>2</sup>');
                e.layer.openPopup();

                search_area_geojson = e.layer.toGeoJSON();
                $('#output').val(search_area_geojson);
                var new_geojson = convertPolygonToOS(search_area_geojson);
                wkt = $.geo.WKT.stringify(new_geojson);

                map.fitBounds(featureGroup.getBounds());
                center_lat_lng = featureGroup.getBounds().getCenter();
                {#                viewreset is really slow #}
                map.addOneTimeEventListener('moveend', function() {
                    alert('moveend');
                    setTimeout(function(){
                        leafletImage(map, doImage);
                    }, 1000);
                });
            }

            var most_recent_search_png = '';
            function doImage(err, canvas) {
                alert('doimage');
                {#                var snapshot = document.getElementById('snapshot');#}

                var img = document.createElement('img');
                var dimensions = map.getSize();
                img.width = dimensions.x;
                img.height = dimensions.y;
                most_recent_search_png = canvas.toDataURL("image/jpeg", 0.5);
                img.src = most_recent_search_png;
                {#                img.style.width = '100%';#}
                {#                snapshot.innerHTML = '';#}
                {#                snapshot.appendChild(img);#}

                $.ajax({
                    url: "{% url 'spatial_search' %}",
                    type: 'POST',
                    data: {
                        geography: wkt,
                        {#                        geojson: search_area_geojson,#}
                        centre_lat_lng: [center_lat_lng.lat, center_lat_lng.lng],
                        geo_area_km2: geoJson_area_km2,
                        start: 0,
                        limit: 15,
                        type: "Qual",
                        uid_only: true,
                        image_png: most_recent_search_png
                    },
                    success: function(data) {
                        {#                        alert(JSON.stringify(data['data']));#}

                        if (data['uid']) {
                            {#                            console.log("{% url 'tables' %}?search_id=" + data['uid']);#}
                            {#                            var snapshot = document.getElementById('output');#}
                            {#                            snapshot.innerHTML = "{% url 'tables' %}?search_id=" + data['uid'];#}

                            setTimeout(function(){
                                {#                                TODO FINDME re-enable this #}
                                window.location = "{% url 'tables' %}?search_id=" + data['uid'];
                            }, 1000);
                        }
                    },
                    complete: function() {
                        {#                        waitingDialog.hide();#}
                                            ajax_finished();

                    }
                });
            }

            String.prototype.format = function() {
                var formatted = this;
                for (var i = 0; i < arguments.length; i++) {
                    var regexp = new RegExp('\\{'+i+'\\}', 'gi');
                    formatted = formatted.replace(regexp, arguments[i]);
                }
                return formatted;
            };

            $("#menu-toggle").click(function(e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });

            {#            setTimeout(function() {#}
            {#                $('#side-menu').removeData("plugin_metisMenu").metisMenu({toggle: false});#}
            {#            }, 2000);#}
            {#            setTimeout(function() {#}
            {#                $('#side-menu').removeData("plugin_metisMenu").metisMenu({toggle: false});#}
            {#            }, 5000);#}

            $( "#chloropleth_option_form" ).dialog({
                autoOpen: false,
                height: map_div.height(),
                width: $('#page-wrapper').width()/2,
                position: {
                    my: "center",
                    at: "center",
                    of: map_div
                },
                modal: true,
                buttons: {
                    "{% trans 'Show New Layer' %}": function() {
                        if ($("#bintype").val() != '') {
                            if ($("#binno").val() != '') {

                                var layer_id = $(this).data('layer_names');
                                var topojson_data = topojson_layers[$(this).data('layer_names')];
                                var nomis_variable = $(this).data('nomis_variable');
                                var layer_name_text = $("#layer_name_text_entry").val();
                                var csv_url = $(this).data('csv_url');

                                var colorpicker = $("#colorpicker").val();
                                var bin_type = $("#bintype").val();
                                var bin_num = $("#binno").val();

                                var saveToLocalStorage = $(this).data('localStorage');
                                if (saveToLocalStorage) {
                                    var all_topojson_data = $(this).data('all_topojson_data');
                                    all_topojson_data['layer_data']['colorpicker'] = colorpicker;
                                    all_topojson_data['layer_data']['bin_type'] = bin_type;
                                    all_topojson_data['layer_data']['bin_num'] = bin_num;
                                    all_topojson_data['layer_data']['name'] = layer_name_text;

                                    if(typeof(Storage) !== "undefined") {
                                        var localLayers = {};
                                        if (localStorage.DataPortalLocalLayers) {
                                            localLayers = JSON.parse(localStorage.getItem('DataPortalLocalLayers'));
                                        }
                                        localLayers[layer_id] = all_topojson_data;
                                        localStorage.setItem("DataPortalLocalLayers", JSON.stringify(localLayers));
                                    } else {
                                        alert('Sorry! Your browser does not support local data storage.');
                                    }
                                }

                                var new_layer = new MapLayer();
                                new_layer.layer_id = $(this).data('layer_names');
                                new_layer.topojson_data = topojson_layers[$(this).data('layer_names')];
                                new_layer.nomis_variable = $(this).data('nomis_variable');
                                new_layer.layer_name_text = $("#layer_name_text_entry").val();
                                new_layer.csv_url = $(this).data('csv_url');
                                new_layer.colorpicker = $("#colorpicker").val();
                                new_layer.bin_type = $("#bintype").val();
                                new_layer.bin_num = $("#binno").val();

                                store.add_layer(new_layer);


                                $.ajax({
                                    url: "{% url 'data_api' %}",
                                    type: 'GET',
                                    data: {
                                        method: 'record_nomis_search',
                                        layer_id: layer_id,
                                        layer_name: layer_name_text,
                                        colorpicker: colorpicker,
                                        bin_type: bin_type,
                                        bin_num: bin_num
                                    },
                                    success: function(data) {},
                                    error: function() {}
                                });

                                try {
                                    handleUploadedLayer(
                                            topojson_data,
                                            colorpicker,
                                            bin_type,
                                            bin_num,
                                            nomis_variable,
                                            layer_name_text,
                                            csv_url
                                    );
                                }catch (e) {
                                    if (e == 'suppressed_data') {
                                        alert("{% trans 'Sorry, an error occurred. \n\n' %}" +
                                                "{% trans 'It looks like your query was too specific, for example, when data are suppressed due to statistical confidentiality considerations. \n\n' %}" +
                                                "{% trans 'In this case, try a larger area to map data for.' %}")
                                    }
                                    else if (e == 'feature_data_0') {
                                        alert("{% trans 'Sorry, an error occurred. \n\n' %}" +
                                                "{% trans 'No data could be found for this query. \n\n' %}" +
                                                "{% trans 'Please try again, or report it.' %}")
                                    } else {

                                        {#                                        console.log(e);#}
                                        alert("{% trans 'Sorry, an error occurred. \n\n' %}" +
                                                "{% trans 'Unfortunately, some types of dataset are incompatible with this service. \n\n' %}" +
                                                "{% trans 'Try being more specific with the dataset variable you are trying to map. \n\n' %}" +
                                                "{% trans 'Or, it may be the case that your query was too specific. For example, when data are suppressed due to statistical confidentiality considerations. ' %}" +
                                                "{% trans 'In this case, try a larger area to map data for.' %}")
                                    }
                                }
                                $(this).dialog("close");

                            }
                        }
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                },
                close: function() {
                }
            });

            $("#new_layer_btn").click(function(e){
                $( "#search-remote-form").dialog( "open" );
            });

            $("#import_local_data_btn").click(function(e){
                $( "#local-data-form").dialog( "open" );
            });

            $('#dataset_select').change(function(e){
                {#                alert(e);#}
            });

            $('#remote_search_term').keyup(function(event){
                if(event.keyCode == 13){
                    $("#remote_search_btn").click();
                }
            });

            $("#remote_search_btn").click(function(e){
                var search_term = $('#remote_search_term').val();
                add_ajax_waiting('{% trans 'Searching NomisWeb...' %}');

                $.ajax({
                    url: "{% url 'data_api' %}",
                    type: 'GET',
                    data: {
                        'method': 'remote_search',
                        'remote_api': 'nomis',
                        'search_term': search_term,
                        'method_data': {
                            'search_term': search_term
                        }
                    },
                    success: function (data) {
                        var dataset_radio = $('#dataset_radio');
                        dataset_radio.find('input').remove().end();
                        dataset_radio.find('label').remove().end();

                        if (data['success'] == false) {
                            alert('{% trans 'Sorry, an error occurred. Please try again, or report it.\n\n' %}' + data['message'])
                        } else {

                            for (var rd_radio in data['datasets']) {
                                var remote_dataset_radio = data['datasets'][rd_radio];
                                var radio_div = $('<div>');

                                radio_div.append($('<input>', {
                                    value: remote_dataset_radio.id,
                                    id: remote_dataset_radio.id,
                                    type: 'radio',
                                    name: 'nomis_search_radio',
                                    text: remote_dataset_radio.name
                                }));
                                radio_div.append($('<label>', {
                                    value: remote_dataset_radio.id,
                                    for: remote_dataset_radio.id,
                                    text: remote_dataset_radio.name
                                }));
                                dataset_radio.append(radio_div);
                            }
                            dataset_radio.buttonset();
                            dataset_radio.find('input[type=radio]').change(function () {
                                $('#add_to_map_dialog_btn').button('enable');
                            });

                            if (data['datasets'].length == 0) {
                                alert("{% trans 'Sorry, no results were found for that search.\n' %}" +
                                        "{% trans 'Please refine the search terms and try again' %}");
                            } else {
                                dataset_radio.find('input[type=radio]').change(function () {
                                    $('#add_to_map_dialog_btn').button('enable');
                                });
                            }
                        }
                    },
                    error: function() {
                        alert('{% trans 'Sorry, an error occurred. Please try again, or report it.\n\n' %}');
                    },
                    complete: function() {
                        {#                        waitingDialog.hide();#}
                        ajax_finished();
                    }
                });
            });

            $( "#search-remote-form" ).dialog({
                autoOpen: false,
                height: map_div.height(),
                position: {
                    my: "center",
                    at: "center",
                    of: map_div
                },
                width: map_div.width() / 2,
                modal: true,
                buttons: [
                    {
                        id: 'add_to_map_dialog_btn',
                        text: '{% trans 'Add to Map' %}',
                        disabled: true,
                        click: function() {
                            add_ajax_waiting('{% trans 'Inspecting dataset ...' %}');

                            $( this ).dialog( "close" );
                            var dataset_id = $("#dataset_radio").find(":radio:checked").attr('id');
                            var dataset_name = $("#dataset_radio").find(":radio:checked").text();

                            $.ajax({
                                url: "{% url 'data_api' %}",
                                type: 'GET',
                                data: {
                                    'method': 'remote_metadata',
                                    'dataset_id': dataset_id
                                },
                                success: function(data){
                                    $('#dataset_title').remove().end().append('<h3>' + dataset_name + '</h2>');

                                    var dataset_radio = $('#data_cell_radio');
                                    dataset_radio.find('div').remove().end();

                                    for(var remote_codelist in data['metadata']['codelists']) {
                                        var remote_codelist_data = data['metadata']['codelists'][remote_codelist];

                                        var codelist_label = $('<div>', {text: remote_codelist_data['name']});
                                        dataset_radio.append(codelist_label);

                                        var codelist_radio_div = $('<div>', {id: remote_codelist + '_radio'});

                                        for(var remote_codelist_option in remote_codelist_data['measures']) {
                                            var remote_codelist_option_data = remote_codelist_data['measures'][remote_codelist_option];

                                            var radio_div = $('<div>');

                                            radio_div.append($('<input>', {
                                                value: remote_codelist_option_data.id,
                                                id: remote_codelist + '_' + remote_codelist_option_data.id,
                                                type: 'radio',
                                                name: (remote_codelist + '_option'),
                                                text: remote_codelist_option_data.name
                                            }));
                                            radio_div.append($('<label>', {
                                                class: 'dialog_radio_option',
                                                value: remote_codelist_option_data.id,
                                                for: remote_codelist + '_' + remote_codelist_option_data.id,
                                                text: remote_codelist_option_data.name
                                            }));
                                            codelist_radio_div.append(radio_div);
                                        }
                                        codelist_radio_div.buttonset().find('input')[0].click();

                                        {#                                        codelist_radio_div.buttonset('refresh');#}
                                        {#                                        alert(codelist_radio_div.find('input').length);#}

                                        dataset_radio.append(codelist_radio_div);
                                    }

                                    $('#topojson_geography_radio').buttonset();
                                    $('#dataset_define_vars_form').data({
                                        'dataset_id': dataset_id,
                                        'dataset_name': dataset_name,
                                        'codelists': data['metadata']['codelists']
                                    }).dialog('open');

                                },
                                error: function() {
                                    alert('{% trans 'Sorry, an error occurred. Please try again, or report it.\n\n' %}');
                                },
                                complete: function() {
                                    {#                                    waitingDialog.hide();#}
                                ajax_finished();
                                }
                            });

                        }},{
                        text: '{% trans 'Cancel' %}',
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ],
                close: function() {
                }
            });
            {#            $('#add_to_map_dialog_btn').button("disable");#}


            $( "#dataset_define_vars_form" ).dialog({
                autoOpen: false,
                height: map_div.height(),
                position: {
                    my: "center",
                    at: "center",
                    of: map_div
                },
                width: map_div.width()/2,
                modal: true,
                buttons: {
                    "{% trans 'Render to Map' %}": function() {
                        add_ajax_waiting('{% trans 'Fetching map layer...' %}');

                        $( this ).dialog( "close" );

                        var codelists = $(this).data('codelists');
                        var codelist_selected = [];

                        var nomis_variable = $("#nomis_variable").val();

                        for(var remote_codelist in codelists) {
                            var remote_codelist_selection = $('#' + remote_codelist +'_radio').find(":radio:checked").attr('value');

                            {#                            alert(remote_codelist + ' ' + remote_codelist_selection);#}
                            codelist_selected.push({
                                option: remote_codelist,
                                variable: remote_codelist_selection
                            });
                            if (remote_codelist == 'MEASURES') {
                                nomis_variable = remote_codelist_selection;
                            }
                        }

                        {#                    console.log(codelist_selected);#}

                        var dataset_id = $(this).data('dataset_id');

                        {#                        var topojson_geography = $("#topojson_geographies").val();#}

                        var topojson_geography = $('#topojson_geography_radio').find(":radio:checked").attr('value');
                        {#                        var topojson_id = dataset_id + '_' + topojson_geography + '_' + nomis_variable;#}
                        {#                        var layer_name = topojson_id;#}



                        get_remote_dataset_topojson(
                                "{% url 'remote_data_topojson' %}",
                                topojson_geography,
                                dataset_id,
                                codelist_selected,
                                function(data){
                                    get_remote_dataset_csv_url(
                                            "{% url 'data_api' %}",
                                            topojson_geography,
                                            dataset_id,
                                            codelist_selected,
                                            function(csv_url) {

                                                {#                                                waitingDialog.hide();#}
                                                ajax_finished();
                                                var layer_name = data['search_uuid'];
                                                topojson_layers[layer_name] = data['topojson'];
                                                $( "#chloropleth_option_form").data({
                                                    layer_names: layer_name,
                                                    nomis_variable: nomis_variable,
                                                    csv_url: csv_url
                                                }).dialog( "open" );
                                            }
                                    );
                                }
                        );
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                },
                close: function() {
                }
            });

            $('#screenshot').click(function() {
                leafletImage(map, screenshot);
            });

            function screenshot(err, map_canvas){

                html2canvas(
                        map_div.find('> div.leaflet-control-container > div.leaflet-bottom.leaflet-left'), {}
                ).then(function(left_overlay_canvas) {
                    {#                            $('#screenshot_result2').append(overlay_canvas);#}

                    var ctx3 = map_canvas.getContext('2d');
                    ctx3.drawImage(
                            left_overlay_canvas,
                            0,
                            map_canvas.height - left_overlay_canvas.height
                    );

                    html2canvas(
                            map_div.find('> div.leaflet-control-container > div.leaflet-bottom.leaflet-right'), {}
                    ).then(function(right_overlay_canvas) {
                        ctx3.drawImage(
                                right_overlay_canvas,
                                map_canvas.width - right_overlay_canvas.width,
                                map_canvas.height - right_overlay_canvas.height
                        );

                        var canvas_data_url = map_canvas.toDataURL("image/png", 0.5);

                        window.open(canvas_data_url, '_blank');
                        {#                                                                $('#screenshot_result').append(map_canvas);#}

                    });
                });
            }


            $( "#local_dataset_define_vars_form" ).dialog({
                autoOpen: false,
                height: map_div.height(),
                position: {
                    my: "center",
                    at: "center",
                    of: map_div
                },
                width: map_div.width()/2,
                modal: true,
                open: function( event, ui ) {
                    var available_data = $(this).data('available_data');
                    var unicode_data = $(this).data('unicode_data');

                    var dataset_radio = $('#local_data_cell_radio');
                    dataset_radio.find('div').remove().end();

                    var codelist_label = $('<div>', {text: 'Available Data'});
                    dataset_radio.append(codelist_label);

                    var codelist_radio_div = $('<div>', {id: 'local_available_data_radio'});
                    for(var available_data_option_idx in available_data) {
                        var available_data_option = available_data[available_data_option_idx];

                        var radio_text = '';
                        if (available_data_option['full_name']){
                            radio_text = available_data_option['full_name'];
                        } else {
                            radio_text = available_data_option['data_name']
                        }

                        var radio_div = $('<div>');
                        radio_div.append($('<input>', {
                            value: available_data_option['data_name'],
                            id: available_data_option['data_name'],
                            type: 'radio',
                            name: 'available_data_option',
                            text: radio_text
                        }));
                        radio_div.append($('<label>', {
                            class: 'dialog_radio_option',
                            value: available_data_option['data_name'],
                            for: available_data_option['data_name'],
                            text: radio_text
                        }));
                        codelist_radio_div.append(radio_div);
                    }

                    for(var available_data_option_idx in unicode_data) {
                        var available_data_option = unicode_data[available_data_option_idx];

                        var uradio_text = '';
                        if (available_data_option['full_name']){
                            uradio_text = available_data_option['full_name'];
                        } else {
                            uradio_text = available_data_option['data_name']
                        }

                        var radio_div = $('<div>');
                        radio_div.append($('<input>', {
                            value: available_data_option['data_name'],
                            id: available_data_option['data_name'],
                            type: 'radio',
                            name: 'available_data_option',
                            text: uradio_text
                        }));
                        radio_div.append($('<label>', {
                            class: 'dialog_radio_option',
                            value: available_data_option['data_name'],
                            for: available_data_option['data_name'],
                            text: uradio_text + ' category'
                        }));
                        codelist_radio_div.append(radio_div);
                    }

                    codelist_radio_div.buttonset();
                    dataset_radio.append(codelist_radio_div);
                    codelist_radio_div.find('input')[0].click();

                },
                buttons: {
                    "{% trans 'Render to Map' %}": function() {
                        add_ajax_waiting('{% trans 'Fetching map layer...' %}');
                        $( this ).dialog( "close" );

                        var local_available_data_selection = $('#local_available_data_radio').find(":radio:checked").attr('value');

                        var survey_id = $(this).data('survey_id');

                        {#                        var topojson_geography = $('#topojson_geography_radio').find(":radio:checked").attr('value');#}
                        var topojson_geography = $(this).data('boundary_name');


                        get_local_dataset_topojson(
                                "{% url 'local_data_topojson' %}",
                                topojson_geography,
                                survey_id,
                                local_available_data_selection,
                                function(data) {
                                    var layer_name = data['search_uuid'];
                                    topojson_layers[layer_name] = data['topojson'];

                                    $( "#chloropleth_option_form").data({
                                        layer_names: layer_name,
                                        nomis_variable: '20301',
                                        csv_url: ''
                                    }).dialog( "open" );
                                }
                        );

                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                },
                close: function() {
                }
            });


            var local_data_layer_data = {{ local_data_layers|jsonify }};
            for (var local_data_layer_idx in local_data_layer_data) {

                (function(){
                    var local_data_layer = local_data_layer_data[local_data_layer_idx];
                    {#                console.log(local_data_layer);#}

                    (function(){
                        get_local_dataset_metadata(
                                '{% url 'data_api' %}',
                                local_data_layer['survey_id'],
                                local_data_layer['boundary_name'],
                                function(metadata){
                                    {#                                    alert(metadata['local_data_metadata']['data_names']);#}
                                    $("#local_dataset_define_vars_form").data({
                                        survey_id: local_data_layer['survey_id'],
                                        boundary_name: local_data_layer['boundary_name'],
                                        available_data: metadata['local_data_metadata']['data_names'],
                                        unicode_data: metadata['local_data_metadata']['unicode_data']
                                    }).dialog('open');
                                }
                        );
                    })();

                    local_data_layer['colorpicker'] = 'Spectral';
                    local_data_layer['bin_type'] = 'k';
                    local_data_layer['bin_num'] = '8';
                    local_data_layer['data_name'] = 'data_name';

                }());
            }

            {#        var local_search_layer_data = {{ local_searches|jsonify }};#}
            {#        do_local_layers(local_search_layer_data, "{% url 'remote_data_topojson' %}");#}

            var layer_uuids = {{ layer_uuids|jsonify }};
            do_layer_uuids(layer_uuids, "{% url 'data_api' %}");

            function do_layer_uuids(layer_uuids, search_layer_topojson_url) {
                for (var uuid_idx in layer_uuids) {
                    var uuid = layer_uuids[uuid_idx];
                    do_layer_single_uuid(uuid, search_layer_topojson_url);
                }
            }

            function do_layer_single_uuid(uuid, search_layer_topojson_url) {
                {#                waitingDialog.show('{% trans 'Fetching map layer...' %}');#}
                add_ajax_waiting('{% trans 'Fetching map layer...' %}');

                $.ajax({
                    url: search_layer_topojson_url,
                    type: 'GET',
                    data: {
                        method: 'search_layer_topojson',
                        search_uuid: uuid
                    },
                    success: function (topojson_data) {
                        {#                        console.log(topojson_data);#}

                        var layer_data = topojson_data['layer_data'];

                        handleUploadedLayer(
                                topojson_data['topojson'],
                                layer_data['colorpicker'],
                                layer_data['bin_type'],
                                layer_data['bin_num'],
                                '',
                                layer_data['name'],
                                ''
                        );
                    },
                    complete: function() {
                        {#                        waitingDialog.hide();#}
                        ajax_finished();
                    }
                });
            }


            function do_layer_by_name(name) {
                add_ajax_waiting('{% trans 'Fetching map layer...' %}');
                $.ajax({
                    url: "{% url 'data_api' %}",
                    type: 'GET',
                    data: {
                        method: 'topojson_layer_by_name',
                        name: name
                    },
                    success: function (topojson_data) {
                        handleUploadedLayer(
                                topojson_data['topojson'],
                                topojson_data['layer_data']['colorpicker'],
                                topojson_data['layer_data']['bin_type'],
                                topojson_data['layer_data']['bin_num'],
                                '',
                                topojson_data['layer_data']['name'],
                                ''
                        );
                    },
                    complete: function() {
                        ajax_finished();
                    }
                });
            }
            {#        lsoa_pembrokshire_point#}
            {#        'pcode_district'#}
            {#        'pcode_point'#}
            {#            do_layer_by_name('pcode_point');#}

            var remote_data_layer_data = {{ remote_searches|jsonify }};
            for (var remote_data_layer_idx in remote_data_layer_data) {

                (function(){
                    var remote_data_layer = remote_data_layer_data[remote_data_layer_idx];
                    {#                console.log(remote_data_layer);#}

                    get_remote_dataset_topojson(
                            "{% url 'remote_data_topojson' %}",
                            remote_data_layer['geography_id'],
                            remote_data_layer['dataset_id'],
                            remote_data_layer['codelist'],
                            function(topojson_data) {
                                {#                            console.log(remote_data_layer);#}

                                handleUploadedLayer(
                                        topojson_data['topojson'],
                                        remote_data_layer['colorpicker'],
                                        remote_data_layer['bin_type'],
                                        remote_data_layer['bin_num'],
                                        '',
                                        remote_data_layer['name'],
                                        ''
                                );
                            }
                    );
                }());
            }


            if (localStorage.DataPortalLocalLayers) {

                var localLayers = JSON.parse(localStorage.getItem('DataPortalLocalLayers'));

                var local_layer_names = Object.keys(localLayers);


                {#                alert('You have ' + local_layer_names.length + ' layers stored locally :\n\n ' + local_layer_names);#}

                for (var name in local_layer_names) {
                    if (local_layer_names.hasOwnProperty(name)) {

                        var topojson_data = localLayers[local_layer_names[name]];
                        handleUploadedLayer(
                                topojson_data['topojson'],
                                topojson_data['layer_data']['colorpicker'],
                                topojson_data['layer_data']['bin_type'],
                                topojson_data['layer_data']['bin_num'],
                                '',
                                topojson_data['layer_data']['name'],
                                ''
                        );
                    }
                }
            }


            var X = XLSX;
            var XW = {
                /* worker message */
                msg: 'xlsx',
                /* worker scripts */
                rABS: './xlsxworker2.js',
                norABS: './xlsxworker1.js',
                noxfer: './xlsxworker.js'
            };

            var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
            if(!rABS) {
                document.getElementsByName("userabs")[0].disabled = true;
                document.getElementsByName("userabs")[0].checked = false;
            }

            var use_worker = typeof Worker !== 'undefined';
            if(!use_worker) {
                document.getElementsByName("useworker")[0].disabled = true;
                document.getElementsByName("useworker")[0].checked = false;
            }

            var transferable = use_worker;
            if(!transferable) {
                document.getElementsByName("xferable")[0].disabled = true;
                document.getElementsByName("xferable")[0].checked = false;
            }

            var wtf_mode = false;

            function fixdata(data) {
                var o = "", l = 0, w = 10240;
                for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
                o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
                return o;
            }

            function ab2str(data) {
                var o = "", l = 0, w = 10240;
                for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
                o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
                return o;
            }

            function s2ab(s) {
                var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
                for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
                return [v, b];
            }

            function xw_noxfer(data, cb) {
                var worker = new Worker(XW.noxfer);
                worker.onmessage = function(e) {
                    switch(e.data.t) {
                        case 'ready': break;
                        case 'e': console.error(e.data.d); break;
                        case XW.msg: cb(JSON.parse(e.data.d)); break;
                    }
                };
                var arr = rABS ? data : btoa(fixdata(data));
                worker.postMessage({d:arr,b:rABS});
            }

            function xw_xfer(data, cb) {
                var worker = new Worker(rABS ? XW.rABS : XW.norABS);
                worker.onmessage = function(e) {
                    switch(e.data.t) {
                        case 'ready': break;
                        case 'e': console.error(e.data.d); break;
                        default: xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
                    }
                };
                if(rABS) {
                    var val = s2ab(data);
                    worker.postMessage(val[1], [val[1]]);
                } else {
                    worker.postMessage(data, [data]);
                }
            }

            function xw(data, cb) {
                transferable = document.getElementsByName("xferable")[0].checked;
                if(transferable) xw_xfer(data, cb);
                else xw_noxfer(data, cb);
            }

            function to_json(workbook) {
                var result = {};
                workbook.SheetNames.forEach(function(sheetName) {
                    var roa = X.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                    if(roa.length > 0){
                        result[sheetName] = roa;
                    }
                });
                return result;
            }

            function to_csv(workbook) {
                var result = [];
                workbook.SheetNames.forEach(function(sheetName) {
                    var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
                    if(csv.length > 0){
                        result.push("SHEET: " + sheetName);
                        result.push("");
                        result.push(csv);
                    }
                });
                return result.join("\n");
            }



            function process_wb(wb) {
                var output_json = to_json(wb);
                var output = JSON.stringify(output_json, 2, 2);
                do_layer_single_local(output_json);

                if(typeof console !== 'undefined') console.log("output", new Date());
            }

            var drop = document.getElementById('drop');
            function handleDrop(e) {
                e.stopPropagation();
                e.preventDefault();
                rABS = document.getElementsByName("userabs")[0].checked;
                use_worker = document.getElementsByName("useworker")[0].checked;
                var files = e.dataTransfer.files;
                var f = files[0];
                {
                    var reader = new FileReader();
                    var name = f.name;
                    reader.onload = function(e) {
                        if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
                        var data = e.target.result;
                        if(use_worker) {
                            xw(data, process_wb);
                        } else {
                            var wb;
                            if(rABS) {
                                wb = X.read(data, {type: 'binary'});
                            } else {
                                var arr = fixdata(data);
                                wb = X.read(btoa(arr), {type: 'base64'});
                            }
                            process_wb(wb);
                        }
                    };
                    if(rABS) reader.readAsBinaryString(f);
                    else reader.readAsArrayBuffer(f);
                }
            }

            function handleDragover(e) {
                e.stopPropagation();
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            }

            if(drop.addEventListener) {
                drop.addEventListener('dragenter', handleDragover, false);
                drop.addEventListener('dragover', handleDragover, false);
                drop.addEventListener('drop', handleDrop, false);
            }


            var xlf = document.getElementById('xlf');
            function handleFile(e) {
                rABS = document.getElementsByName("userabs")[0].checked;
                use_worker = document.getElementsByName("useworker")[0].checked;
                var files = e.target.files;
                var f = files[0];
                {
                    var reader = new FileReader();
                    var name = f.name;
                    reader.onload = function(e) {
                        if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
                        var data = e.target.result;
                        if(use_worker) {
                            xw(data, process_wb);
                        } else {
                            var wb;
                            if(rABS) {
                                wb = X.read(data, {type: 'binary'});
                            } else {
                                var arr = fixdata(data);
                                wb = X.read(btoa(arr), {type: 'base64'});
                            }
                            process_wb(wb);
                        }
                    };
                    if(rABS) reader.readAsBinaryString(f);
                    else reader.readAsArrayBuffer(f);
                }
            }

            if(xlf.addEventListener) xlf.addEventListener('change', handleFile, false);

            var area_values = {};
            function do_layer_single_local(json_object) {
                $('#local-data-drop-zone').hide();

                ordered_data = {};
                var worksheet_name = Object.keys(json_object)[0];
                area_values = json_object[worksheet_name];
                var column_headers = Object.keys(area_values[0]);

                var dataset_radio = $('#local_column_headers_radio');
                dataset_radio.find('div').remove().end();

                var codelist_label = $('<div>', {text: '{% trans 'Select geography id column' %}'});
                dataset_radio.append(codelist_label);

                var codelist_radio_div = $('<div>', {id: 'local_data_geography_radio'});
                for(var column_header_idx in column_headers) {
                    if(column_headers.hasOwnProperty(column_header_idx))
                        var column_header_option = column_headers[column_header_idx];

                    var radio_text = column_header_option;

                    var radio_div = $('<div>');
                    radio_div.append($('<input>', {
                        value: column_header_option,
                        id: column_header_option,
                        type: 'radio',
                        name: 'available_data_option',
                        text: radio_text
                    }));
                    radio_div.append($('<label>', {
                        class: 'dialog_radio_option',
                        value: column_header_option,
                        for: column_header_option,
                        text: radio_text
                    }));
                    codelist_radio_div.append(radio_div);
                }
                codelist_radio_div.buttonset();
                dataset_radio.append(codelist_radio_div);


                var codelist_label = $('<div>', {text: '{% trans 'Select data value column' %}'});
                dataset_radio.append(codelist_label);

                var local_data_value_radio_div = $('<div>', {id: 'local_data_value_radio'});
                for(var column_header_idx in column_headers) {
                    if(column_headers.hasOwnProperty(column_header_idx))
                        var column_header_option = column_headers[column_header_idx];

                    var radio_text = column_header_option;

                    var radio_div = $('<div>');
                    radio_div.append($('<input>', {
                        value: column_header_option,
                        id: column_header_option + '_value',
                        type: 'radio',
                        name: 'local_data_value_option',
                        text: radio_text
                    }));
                    radio_div.append($('<label>', {
                        class: 'dialog_radio_option',
                        value: column_header_option,
                        for: column_header_option + '_value',
                        text: radio_text
                    }));
                    local_data_value_radio_div.append(radio_div);
                }
                local_data_value_radio_div.buttonset();
                dataset_radio.append(local_data_value_radio_div);



                var codelist_label = $('<div>', {text: '{% trans 'Select additional secondary data' %}'});
                dataset_radio.append(codelist_label);

                var local_data_secondary_check_div = $('<div>', {id: 'local_data_secondary_check'});
                for(var column_header_idx in column_headers) {
                    if(column_headers.hasOwnProperty(column_header_idx))
                        var column_header_option = column_headers[column_header_idx];

                    var radio_text = column_header_option;

                    var radio_div = $('<div>');
                    radio_div.append($('<input>', {
                        value: column_header_option,
                        id: column_header_option + '_secondary',
                        type: 'checkbox',
                        name: 'local_data_secondary_option',
                        text: radio_text
                    }));
                    radio_div.append($('<label>', {
                        class: 'dialog_radio_option',
                        value: column_header_option,
                        for: column_header_option + '_secondary',
                        text: radio_text
                    }));
                    local_data_secondary_check_div.append(radio_div);
                }
                local_data_secondary_check_div.buttonset();
                dataset_radio.append(local_data_secondary_check_div);

            }


            $( "#local-data-form" ).dialog({
                autoOpen: false,
                height: map_div.height(),
                position: {
                    my: "center",
                    at: "center",
                    of: map_div
                },
                width: map_div.width() / 2,
                modal: true,
                buttons: [
                    {
                        id: 'save_local_data_dialog_btn',
                        text: '{% trans 'Save' %}',
                        click: function() {

                            var local_data_name = $('#local_data_name_input').val();
                            var local_data_value_column = $('#local_data_value_radio').find(":radio:checked").attr('value');
                            var local_data_geography_column = $('#local_data_geography_radio').find(":radio:checked").attr('value');

                            var topojson_layer_name = '';

                            {#                            FIXME remove codes #}
                            {#                            var codes = ['W09000001', 'W09000002'];#}
                            var codes = [];

                            var ordered_data = {};
                            for (var area in area_values) {
                                if (area_values.hasOwnProperty(area)) {
                                    ordered_data[area_values[area][local_data_geography_column]] = area_values[area][local_data_value_column];

                                    var geo_string = area_values[area][local_data_geography_column];

                                    if (isPostcodeish(geo_string)) {
                                        topojson_layer_name = 'pcode_point';
                                        var clean_geostring = geo_string.replace(' ', '');
                                        {#                                        codes.push(geo_string.slice(0, -2))#}
                                        codes.push(geo_string.slice(0, -2))

                                    }

                                    if (geo_string.substring(0, 3) == 'W09') {
                                        topojson_layer_name = 'assembly_constituency';
                                        codes.push(geo_string);
                                    }
                                }
                            }

                            $.ajax({
                                url: "{% url 'data_api' %}",
                                type: 'GET',
                                data: {
                                    method: 'topojson_layer_by_name',
                                    name: topojson_layer_name,
                                    codes: codes
                                },
                                success: function (all_topojson_data) {

                                    var secondary_data_keys = [];
                                    $('#local_data_secondary_check').find(":checkbox:checked").each(function (index) {
                                        secondary_data_keys.push($(this).attr('value'));
                                    });
                                    console.log('outer 2nd keys');
                                    console.log(secondary_data_keys);
                                    all_topojson_data = thing(all_topojson_data, ordered_data, local_data_name,
                                            area_values, local_data_geography_column, secondary_data_keys);

                                    console.log(jQuery.extend(true, {}, all_topojson_data));

                                    var layer_name = all_topojson_data['search_uuid'];
                                    topojson_layers[layer_name] = all_topojson_data['topojson'];

                                    $( "#chloropleth_option_form").data({
                                        layer_names: layer_name,
                                        nomis_variable: '20301',
                                        csv_url: '',
                                        localStorage: true,
                                        all_topojson_data: all_topojson_data
                                    }).dialog( "open" );
                                },
                                complete: function() {
                                    $("#local-data-form").dialog( "close" );
                                }
                            });


                        }},{
                        text: '{% trans 'Cancel' %}',
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ],
                close: function() {
                }
            });

        });

    </script>

    <div class="row" style="height: 100%; margin-right: 0">
        <div class="col-lg-9 col-sm-12" style="padding-right: 0">
            <div id="map_div"></div>
        </div>

        <div class="col-lg-3 col-sm-12" style="padding-right: 0">

            <div class="right_sidebar" id="right_sidebar"
                 style="
{#                         background-color: #f8f8f8;#}
                         border-left: 1px solid #e7e7e7;
                         height: 100%;
                         {#                                  position: absolute; right: 0;#}
                         {#                         width:250px;#}
                         width: 100%;
                         overflow-y: scroll;
                         overflow-x: hidden">

                {#                <div class="row">#}
                {#                    <div class="col-lg-12">#}
                <div class="split-pane-component" id="right-component1"
                     style="margin: 0.5em;
                             {#                     word-break: break-all;#}
                             word-wrap: normal; word-break: normal"></div>
                {#                    </div>#}
                {#                    <div class="col-lg-12">#}
                {#                        <div class="split-pane-component" id="right-component2"></div>#}
                {#                    </div>#}
                {#                </div>#}
            </div>
        </div>
    </div>

    <div class="">
        <div class="col-lg-12">

            {#            <div id="naw_output" >NAW = {{ naw }}</div>#}
            {#            <div id="outputs">{{ local_data_layers }}<br><br>{{ local_searches }}</div>#}
            <div id="screenshot" class="btn">{% trans "Screenshot" %}</div>
            <div id="screenshot_result"></div>
            {#                <div id="screenshot_result2"></div>#}
            {#                        <div id="language">Language : {{ preferences.preferred_language.user_language_title }}</div>#}
        </div>
    </div>
    <div id="chloropleth_option_form" title="{% trans 'Chloropleth options' %}">
        <table>
            <tr>
                <td>
                    <label for="bintype" class="control-label">{% trans "Category Types" %}</label>
                </td>
                <td>
                    <div class="controls">
                        <select name="bintype" id="bintype" class="form-control input-block-level tab_data_input">
                            <option value="e">{% trans 'Equal size categories' %}</option>
                            <option value="q" selected="selected">{% trans 'Quantiles' %}</option>
                            <option value="k">{% trans 'K-Means' %}</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="binno" class="control-label">{% trans 'Number of Categories' %}</label>
                </td>
                <td>
                    <select name="binno" id="binno" class="form-control input-block-leveltab_data_input">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5" selected="selected">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="colorpicker" class="control-label">{% trans 'Choropleth colour scheme' %}</label>
                </td>
                <td>
                    <select name="colorpicker" id="colorpicker" class="form-control input-block-level tab_data_input">
                        <option value="OrRd">{% trans 'Orange - Red' %}</option>
                        <option value="RdYlBu">{% trans 'Red - Yellow - Blue' %}</option>
                        <option value="YlGnBu" selected="selected">{% trans 'Yellow - Green - Blue' %}</option>
                        <option value="Spectral">{% trans 'Spectral' %}</option>
                        <option value="b_w">{% trans 'Greyscale' %}</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="layer_name_text_entry" class="control-label">{% trans 'Layer Name' %}</label>
                </td>
                <td>
                    <input class="form-control input-block-level tab_data_input"
                           id="layer_name_text_entry" type="text">
                </td>
            </tr>
        </table>

    </div>


    <div id="dataset_define_vars_form" title="{% trans 'Dataset Variables' %}">
        <div id="dataset_title"></div>
        <div id="data_cell_radio"></div>

        <div>{% trans 'Geography' %}</div>
        <div id="topojson_geography_radio" class="controls input-block-level tab_data_input">
            {% for geography in topojson_geographies %}
                <div>
                    <input type="radio" name="geographies" id="{{ geography.geog_short_code }}"
                           value="{{ geography.geog_short_code }}"/>
                    <label for="{{ geography.geog_short_code }}">{{ geography.name }}</label>
                </div>
            {% endfor %}
        </div>
    </div>

    <div id="local_dataset_define_vars_form" title="{% trans 'Dataset Variables' %}">
        <div id="local_dataset_title"></div>
        <div id="local_data_cell_radio"></div>

        <div>{% trans 'Geography' %}</div>
        <div id="topojson_geography_radio" class="controls input-block-level tab_data_input">

        </div>
    </div>


    <div id="search-remote-form" title="{% trans 'Search Remote' %}">
        <div class="input-group custom-search-form">
            <label for="remote_search_term" class="control-label">{% trans 'Search Remote' %}</label>
        </div>
        <div class="input-group custom-search-form">
            <input type="text" id="remote_search_term" name="remote_search_term"
                   class="form-control" placeholder="{% trans 'Search...' %}" name="search_terms">
                        <span class="input-group-btn">
                            <button id="remote_search_btn" class="btn btn-default" type="submit">
                                <i class="fa fa-search"></i>
                            </button>
                        </span>
        </div>
        <fieldset>
            <div id="dataset_radio"></div>
        </fieldset>
    </div>

    <div id="local-data-form" title="{% trans 'Local Data' %}">
        <div id="local-data-drop-zone" class="input-group custom-search-form">
            <div id="drop">Drop an XLSX / XLSM / XLSB / ODS / XLS / XML file here to see sheet data</div>
            <p><input type="file" name="xlfile" id="xlf" /></p>
        </div>

        <div class="input-group custom-search-form">
            <label for="local_data_name_input" class="control-label">{% trans 'Name this Layer' %}</label>
        </div>
        <div class="input-group custom-search-form">
            <input type="text" id="local_data_name_input" name="local_data_name"
                   class="form-control" placeholder="{% trans 'New Layer...' %}">
        </div>
        <div>
            <div id="local_column_headers_radio"></div>
        </div>
    </div>

    <input hidden="hidden" type="checkbox" name="useworker" disabled>
    <input hidden="hidden" type="checkbox" name="xferable" disabled>
    <input hidden="hidden" type="checkbox" name="userabs" checked>

{% endblock %}

